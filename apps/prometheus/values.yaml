# Prometheus (standalone) - Lab Configuration
# Chart: prometheus 27.0.0

prometheus:
  # Disable components we don't need
  alertmanager:
    enabled: false

  prometheus-pushgateway:
    enabled: false

  kube-state-metrics:
    enabled: false

  prometheus-node-exporter:
    enabled: false

  # Prometheus server
  server:
    service:
      type: LoadBalancer

    # Enable remote write receiver for Alloy/Tempo
    extraFlags:
      - "web.enable-remote-write-receiver"

    persistentVolume:
      enabled: true
      storageClass: "gp3"
      size: 10Gi

    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

  serverFiles:
    prometheus.yml:
      scrape_configs:
        # Flask Interface - Ansible Job Metrics
        - job_name: 'flask-interface'
          kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                  - flask-interface
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
              action: keep
              regex: true
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: kubernetes_namespace
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: kubernetes_pod_name

        # Blackbox exporter - ICMP probe (ping/latency)
        - job_name: 'blackbox-icmp'
          metrics_path: /probe
          params:
            module: [icmp]
          static_configs:
            - targets:
                - 67.217.62.83
                - 34.236.145.212
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc:9115

        # Blackbox exporter - HTTP probe (response time, status codes, SSL)
        - job_name: 'blackbox-http'
          metrics_path: /probe
          params:
            module: [http_2xx]
          static_configs:
            - targets:
                - https://www.google.com
                - https://example.com
                # Add your web endpoints here
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc:9115
